# Bulletin Email Auth Tokens

## Date: 2026-02-28

## Problem
Bulletin email links are plain URLs. When a recipient clicks through, we don't know who they are unless they're already logged in. But clicking a link in an email sent to their address proves email ownership — same proof as a magic link.

## Design
Every bulletin email link includes a per-user token. Clicking any link auto-authenticates the user (sets session cookies) and redirects to the destination page.

### Flow
1. Cron generates one token per subscriber, stores in `bulletin_tokens` table
2. All email links become: `{base_url}/api/verify-bulletin-token.php?bt=<token>&dest=/elections/threats.php`
3. Handler validates token, creates device session via `tpbSetLoginCookies()`, redirects to `dest`
4. User lands on threats.php fully authenticated — sees share buttons, subscribe toggle, etc.

### DB
```sql
CREATE TABLE bulletin_tokens (
  token_id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  token VARCHAR(64) NOT NULL UNIQUE,
  expires_at DATETIME NOT NULL,
  used_at DATETIME DEFAULT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_token (token),
  INDEX idx_user (user_id)
);
```

### Token rules
- Generated by `bin2hex(random_bytes(16))` — 32-char hex string
- Expires after 7 days (new one issued each daily bulletin)
- Multi-use within the 7-day window (people re-open emails, click multiple links)
- `used_at` set on first use for analytics
- Old expired tokens cleaned up by cron before generating new ones

### Files
- `scripts/db/add-bulletin-tokens.sql` — migration
- `api/verify-bulletin-token.php` — token validator + auth + redirect (follows `verify-magic-link.php` pattern)
- `scripts/maintenance/send-threat-bulletin.php` — generate token per subscriber, pass to `buildEmailHtml()`, personalize all links

### Security
- Tokens are random 128-bit values (cryptographically secure)
- 7-day expiry limits exposure window
- `dest` parameter validated to start with `/` (relative URLs only, no open redirect)
- Follows same device session pattern as magic links
