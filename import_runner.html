<!DOCTYPE html>
<html>
<head>
    <title>OpenStates Import Runner</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 { color: #d4af37; }
        #status { 
            background: #000; 
            padding: 15px; 
            border: 1px solid #333;
            margin: 20px 0;
            min-height: 50px;
        }
        #log {
            background: #000;
            padding: 15px;
            border: 1px solid #333;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .error { color: #f00; }
        .success { color: #0f0; }
        .info { color: #0ff; }
        button {
            background: #d4af37;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            cursor: pointer;
            margin: 10px 5px 10px 0;
        }
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        #progress {
            background: #333;
            height: 30px;
            margin: 20px 0;
            border-radius: 5px;
            overflow: hidden;
        }
        #progressBar {
            background: #d4af37;
            height: 100%;
            width: 0%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>üèõÔ∏è OpenStates Import Runner</h1>
    
    <div id="status">Ready to import. Click Start to begin.</div>
    
    <div id="progress">
        <div id="progressBar">0 / 18</div>
    </div>
    
    <button id="startBtn" onclick="startImport()">‚ñ∂ Start Import</button>
    <button id="stopBtn" onclick="stopImport()" disabled>‚èπ Stop</button>
    <button onclick="clearLog()">Clear Log</button>
    
    <div id="log"></div>

    <script>
        const BASE_URL = 'https://tpb2.sandgems.net/import_openstates.php?key=tpb2025import&batch=';
        const TOTAL_BATCHES = 18;
        const DELAY_BETWEEN_BATCHES = 30000; // 30 seconds between batches
        
        let currentBatch = 1;
        let isRunning = false;
        let totalLegislators = 0;
        let totalErrors = 0;
        
        function log(msg, type = '') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<span class="${type}">[${time}] ${msg}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(msg) {
            document.getElementById('status').textContent = msg;
        }
        
        function updateProgress() {
            const pct = ((currentBatch - 1) / TOTAL_BATCHES) * 100;
            document.getElementById('progressBar').style.width = pct + '%';
            document.getElementById('progressBar').textContent = `${currentBatch - 1} / ${TOTAL_BATCHES}`;
        }
        
        async function runBatch(batch) {
            log(`Starting batch ${batch}...`, 'info');
            updateStatus(`Running batch ${batch} of ${TOTAL_BATCHES}...`);
            
            try {
                const response = await fetch(BASE_URL + batch);
                const text = await response.text();
                
                // Parse results from response
                const legislatorsMatch = text.match(/Legislators:\s+(\d+)/);
                const errorsMatch = text.match(/Errors:\s+(\d+)/);
                const statesMatch = text.match(/States:\s+([a-z, ]+)/i);
                
                const legislators = legislatorsMatch ? parseInt(legislatorsMatch[1]) : 0;
                const errors = errorsMatch ? parseInt(errorsMatch[1]) : 0;
                const states = statesMatch ? statesMatch[1] : 'unknown';
                
                totalLegislators += legislators;
                totalErrors += errors;
                
                log(`Batch ${batch} complete: ${legislators} legislators, ${errors} errors`, 
                    errors > 0 ? 'error' : 'success');
                log(`  States: ${states}`, 'info');
                
                return { success: true, legislators, errors };
                
            } catch (err) {
                log(`Batch ${batch} FAILED: ${err.message}`, 'error');
                return { success: false, legislators: 0, errors: 1 };
            }
        }
        
        async function startImport() {
            if (isRunning) return;
            
            isRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            log('=== IMPORT STARTED ===', 'info');
            log(`Running ${TOTAL_BATCHES} batches (3 states each)`, 'info');
            
            while (currentBatch <= TOTAL_BATCHES && isRunning) {
                await runBatch(currentBatch);
                currentBatch++;
                updateProgress();
                
                if (currentBatch <= TOTAL_BATCHES && isRunning) {
                    log(`Waiting 30s before next batch...`, 'info');
                    await new Promise(r => setTimeout(r, DELAY_BETWEEN_BATCHES));
                }
            }
            
            if (currentBatch > TOTAL_BATCHES) {
                log('=== IMPORT COMPLETE ===', 'success');
                log(`Total legislators: ${totalLegislators}`, 'success');
                log(`Total errors: ${totalErrors}`, totalErrors > 0 ? 'error' : 'success');
                updateStatus(`COMPLETE! ${totalLegislators} legislators imported.`);
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressBar').textContent = '18 / 18 ‚úì';
            } else {
                log('=== IMPORT STOPPED ===', 'error');
                updateStatus(`Stopped at batch ${currentBatch - 1}`);
            }
            
            isRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
        }
        
        function stopImport() {
            isRunning = false;
            log('Stopping after current batch...', 'error');
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
    </script>
</body>
</html>
